---
name: golden-test-authoring
description: Use when creating golden test input files for gomdlint rules. Enforces exact file conventions, naming, content structure, and edge-case patterns. Must be invoked for every new test case file.
---

# Golden Test Authoring

## Overview

Create hand-crafted golden test input files for gomdlint rules. Each input file must exercise a specific scenario with clear, minimal markdown that isolates the behavior being tested.

## File Conventions

### Directory Structure

```
pkg/lint/rules/testdata/<RULE_ID>/<scenario>.input.md
```

Rule IDs use uppercase: `MD009`, `MD031`, `MDL001`, `MDL003`.

### File Set Per Test Case

Each test case produces 4 files. You create ONLY the `.input.md` file. The other 3 are generated by running tests with `-update`:

| File | Created By | Purpose |
|------|-----------|---------|
| `<scenario>.input.md` | You (hand-crafted) | Markdown with violations |
| `<scenario>.golden.md` | `go test -update` | Expected output after fixes |
| `<scenario>.diags.json` | `go test -update` | Expected diagnostics as JSON |
| `<scenario>.diags.txt` | `go test -update` | Expected diagnostics as text |

### Naming Conventions

- Use lowercase snake_case: `basic`, `clean`, `frontmatter`, `code_block_immunity`
- Names must match the edge-case category exactly (see category table below)
- Exception: rule-specific scenarios use descriptive names (e.g., `detect_bash` for MD040)

## Content Rules

### Every input file MUST:

1. **Be valid markdown** â€” parseable by goldmark (CommonMark + GFM extensions)
2. **Have a clear heading** describing what's being tested (e.g., `# MD009 Trailing Spaces - Frontmatter`)
3. **Contain ONLY violations relevant to the rule being tested** â€” don't accidentally trigger other rules unless that's the specific test (use clean markdown structure otherwise)
4. **End with a trailing newline** (unless testing MD047 specifically)
5. **Use LF line endings** (unless the specific test is `crlf`)

### Every `clean` input file MUST:

1. Have zero violations for the rule being tested
2. Use well-structured markdown that could plausibly contain violations but doesn't
3. Not be trivially empty â€” include enough content to exercise the rule's scanning logic

### Content size guidelines:

- `basic` and `clean`: 5-15 lines
- `multiple` and `adjacent`: 15-30 lines
- `large_content`: 200+ lines (with violation near the end)
- All others: 10-25 lines

## Edge Case Category Templates

### frontmatter

```markdown
---
title: Test Document
author: Test Author
---

# Heading After Frontmatter

[Content with the specific violation for this rule]
```

The violation MUST appear after the frontmatter block. This tests that the rule correctly handles the frontmatter offset.

### code_block_immunity

```markdown
# Code Block Immunity Test

Normal content with no violations.

```python
[Content that LOOKS like a violation but is inside a code block]
```

More normal content.

    [Content that LOOKS like a violation but is in an indented code block]

Final clean content.
```

The golden output MUST match the input exactly (no fixes applied inside code blocks). The diags.json MUST be `[]`.

### unicode

```markdown
# Unicode Content Test

[Violation near emoji] ðŸŽ‰
[Violation near CJK] ä½ å¥½ä¸–ç•Œ
[Violation near accented] cafe\u0301 cre\u0300me
```

Tests that byte-offset calculations are correct with multi-byte characters.

### nested

```markdown
# Nested Context Test

> [Violation inside blockquote]

- List item with [violation]
  - Nested list item with [violation]

> > [Violation in nested blockquote]
```

### crlf

Create with `\r\n` line endings throughout. The fix must preserve `\r\n` endings and not corrupt them to mixed endings.

**IMPORTANT:** When writing CRLF files, use a script or explicit byte writing. Do NOT rely on text editors which may normalize line endings.

### multiple

Include 5+ violations of the same type spread throughout the file. Tests that batch fix application with offset shifting works correctly.

### adjacent

Include 2-3 violations on consecutive lines or the same line (if the rule can produce multiple diagnostics per line). Tests that fixing one doesn't corrupt the other.

### empty_file

Only applicable to rules that check document-level properties:
- MD041 (first-line-heading): empty file has no heading
- MD047 (single-trailing-newline): empty file may lack newline

Content is either completely empty or just whitespace.

### large_content

```markdown
# Large Content Test

[200+ lines of clean content that passes the rule]

[Then 1-3 violations near the end]
```

Use generic clean paragraphs (e.g., `Paragraph N content here.`) to fill space. The key is that violations have large byte offsets.

### html_mixed

```markdown
# HTML Mixed Content Test

<div class="wrapper">

[Violation near HTML]

</div>

Content with <span>inline HTML</span> and [violation].
```

### table_context

```markdown
# Table Context Test

| Header 1 | Header 2 |
|----------|----------|
| [violation] | Clean |
| Clean | [violation] |
```

### link_context

```markdown
# Link Context Test

[Text with violation](https://example.com)
[Clean text](https://example.com/path with violation)
![Alt with violation](image.png)
```

### escaped_chars

```markdown
# Escaped Characters Test

\*not emphasis\* with [violation]
\# not a heading with [violation]
Content with \[not a link\] and [violation]
```

### consecutive_blanks

Include 3+ blank lines around the violation site. Tests interaction with MD012.

### trailing_content

File does NOT end with a newline. Tests interaction with MD047.

## Generating Golden Files

After creating `.input.md` files, generate the golden files:

```bash
cd /Volumes/Development/gomdlint
go test -update ./pkg/lint/rules/... -run TestGoldenPerRule/<RULE_ID>
```

For a specific test case:
```bash
go test -update ./pkg/lint/rules/... -run "TestGoldenPerRule/<RULE_ID>/<scenario>"
```

## Verification After Generation

After generating golden files, you MUST verify:

1. **Read the generated `.golden.md`** â€” confirm the fix is correct
2. **Read the generated `.diags.json`** â€” confirm diagnostics are accurate (line, column, message, fixable)
3. **For `clean` cases** â€” confirm `.golden.md` matches `.input.md` exactly and `.diags.json` is `[]`
4. **For `code_block_immunity` cases** â€” confirm `.golden.md` matches `.input.md` exactly and `.diags.json` is `[]`
5. **Run round-trip test** â€” confirm `TestGoldenRoundTrip` passes for the new case

```bash
go test ./pkg/lint/rules/... -run "TestGoldenRoundTrip/<RULE_ID>/<scenario>"
```

## Common Mistakes

| Mistake | Why It's Wrong | Fix |
|---------|---------------|-----|
| Accidentally triggering other rules | Muddies diagnostic output for per-rule tests | Use clean markdown structure; only violate the target rule |
| Missing trailing newline | Triggers MD047 unexpectedly | Always end with `\n` unless testing MD047 |
| Using tabs for indentation | Triggers MD010 unexpectedly | Use spaces unless testing MD010 |
| Trailing whitespace in clean content | Triggers MD009 unexpectedly | Ensure no trailing spaces/tabs |
| Multiple blank lines | Triggers MD012 unexpectedly | Use single blank lines unless testing MD012 |
| Starting without H1 | Triggers MD041 unexpectedly | Start with `# Heading` unless testing MD041 |
| Inconsistent heading style | Triggers MD003 unexpectedly | Use ATX style consistently |
| Non-incrementing headings | Triggers MD001 unexpectedly | Use proper heading hierarchy |
